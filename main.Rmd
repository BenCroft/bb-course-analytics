---
title: "Untitled"
output: html_document
fig_width: 8
fig_height: 7
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set new parameters for reproducible pipeline

```{r}
course <- 'BIOL_228_4001'
```


## Load libraries

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)
library(stringr)
library(ggrepel)
```

## Load helper scripts (functions)

```{r}
source("./scripts/wrangling.R")
source("./scripts/visualizer.R")
```

## Load viz theme (put in `visualizer.R` later)

```{r}
my_theme <- function() {
  background_color <- "transparent" #"transparent"
  # Other key values
  theme_bw(base_size = 18, base_family = "Avenir") +#%+replace% 
    #quartzFonts(ANXTC = c("Avenir Next Condensed Regular", "Avenir Next Condensed Demi Bold", "Avenir Next Condensed Italic", "Avenir Next Condensed Demi Bold Italic"))
    #theme(text = element_text(family = "ANXTC")) +
    theme(panel.background = element_rect(fill = background_color, color = NA)) +
    theme(panel.border = element_rect(color = background_color)) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(panel.grid.major.y = element_line(colour = "#dddddd", linetype = "dotted", size = 1)) + 
    #theme(panel.grid.major.x=element_blank()) +    
    #theme(panel.grid.minor.y = element_line(colour = "#B6B6B9", linetype = "dotted")) + 
    #theme(panel.grid.minor.x =element_blank()) +    
    theme(plot.background = element_rect(fill = background_color, color = NA)) +
    theme(plot.title = element_text(color = "gray30", face = "bold", size = 20, vjust = 1.00)) +
    theme(plot.subtitle = element_text(color = "#707276",  face = "plain", size = 16)) +   
    theme(plot.caption = element_text(color = "#707276", size = 12, face = "plain")) +
    #theme(strip.background = element_rect(fill="white")) +
    theme(axis.ticks = element_blank()) +
    theme(axis.line = element_line(color = "grey30", size = 0.5, linetype = "solid")) + 
    theme(axis.text.x = element_text(size = 16, color = "gray30")) +
    theme(axis.text.y = element_text(size = 16, color = "gray30")) +
    theme(axis.title.x = element_text(size = 16, color = "gray50", vjust = 0)) +
    theme(axis.title.y = element_text(size = 16, color = "gray50", vjust = 1.00)) + 
    theme(legend.position = "top") + #theme(legend.position = "") +
    theme(legend.background = element_rect(fill = background_color)) +
    theme(legend.key = element_rect(color = background_color)) +
    theme(legend.key.width = unit(0.9, "cm")) +
    theme(legend.key.height = unit(0.9, "cm")) +
    theme(legend.text = element_text(size = 14, face = "plain", color = "gray50")) +
    theme(legend.title = element_text(size = 16, face = "bold")) +
    theme(plot.margin = margin(1, 1, 1, 1, "cm")) 
}
```


## Load data

### Set course path

```{r}
course_directory <- paste0("/Volumes/Departments/Extended\ Studies/DEHistData/Analytics_BC/", course, '/input/')
```

### Set data paths

```{r}
dynamics_path <- paste0(course_directory, "dynamics.csv")
grades_path <-paste0(course_directory, "grades.csv")
items_path <- paste0(course_directory, "items.csv")
statics_path <- paste0(course_directory, "statics.csv")
submissions_path <- paste0(course_directory, "submissions.csv")
sis_path <- paste0(course_directory, "sis.csv")
```

### Read data into memory

```{r}
dynamics_input    <- read.csv(dynamics_path)
grades_input      <- read.csv(grades_path)
items_input       <- read.csv(items_path)
statics_input     <- read.csv(statics_path)
submissions_input <- read.csv(submissions_path)
sis_input         <- read.csv(sis_path)
```

```{r}
dynamics <- dynamics_input
grades <- grades_input
items <- items_input
statics <- statics_input
submissions <- submissions_input
sis <- sis_input
```


## Process data

```{r}
## Ensure equal lengths among datasets
# length(unique(dynamics$StudentName))
# length(unique(grades$StudentName))
# length(unique(items$StudentName))
# length(unique(statics$StudentName))
# length(unique(dynamics$StudentName))
```

### Fix time formatting in `dynamics`

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
dynamics <- fix_time_band_24hr(dynamics)
dynamics <- fix_week_level(dynamics)
dynamics <- fix_day_of_week(dynamics)
```

### Fix data type in `sis`

```{r}
sis <- sis %>%
  mutate(StudentID = as.character(StudentID))
```


### Anonymize student identifiers

#### Create StudentID column

```{r}
dynamics <- create_student_id_col(dynamics)
grades <- create_student_id_col(grades)
items <- create_student_id_col(items)
statics <- create_student_id_col(statics)
```

#### Create anonymous/random ids

```{r}
set.seed(1)

student_roster <- union(dynamics$StudentID, grades$StudentID) # Intersect dynamics and grades
student_roster <- union(student_roster, items$StudentID)      # Intersect items    
student_roster <- union(student_roster, statics$StudentID)    # Intersect statics
student_roster <- union(student_roster, sis$StudentID)        # Intersect sis

student_count <- length(unique(student_roster))
student_anon_ids <- sample(10000:99999, student_count, replace=FALSE)
student_anon_df <- data.frame(student_roster, student_anon_ids) %>%
  rename(StudentID = student_roster, StudentID_Anon = student_anon_ids)

dynamics <- left_join(dynamics, student_anon_df, by = c("StudentID"))
grades <- left_join(grades, student_anon_df, by = c("StudentID"))
items <- left_join(items, student_anon_df, by = c("StudentID"))
statics <- left_join(statics, student_anon_df, by = c("StudentID"))
sis <- left_join(sis, student_anon_df, by = c("StudentID"))
```

#### Remove PII

```{r}
dynamics <- dynamics %>%
  select(-StudentName, -StudentID)
grades <- grades %>%
  select(-StudentName, -StudentID)
items <- items %>%
  select(-StudentName, -StudentID)
statics <- statics %>%
  select(-StudentName, -StudentID)
sis <- sis %>%
  select(-StudentName, -StudentID, -EmployeeID)
```

### Remove duplicates

```{r}
# Find duplicates in students - largely due to multiple AcademicPlan values per student
# sis %>%
#   select(-AcademicSubPlan, -AcademicPlan) %>%
#   distinct() %>%
#   group_by(StudentID_Anon) %>%
#   summarise(count = n()) %>%
#   arrange(desc(count)) 

sis_no_acad_plan <- sis %>%
  select(-AcademicPlan, -AcademicSubPlan) %>%
  distinct()
```

```{r}
statics %>%
  #select(-AcademicSubPlan, -AcademicPlan) %>%
  # distinct() %>%
  group_by(StudentID_Anon) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

```




## Visualization

### Outcomes

#### Final Grade Distribution

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
viz <- viz_FinalGradeDistribution(statics)
viz
```

#### Outcomes by Student Credit Load

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
statics %>%
  left_join(sis_no_acad_plan, by = "StudentID_Anon") %>%
  filter(!SISGradeLetter %in% c('W', 'CW', 'I')) %>%
  ggplot(aes(y = NormalizedScore, x = FullTimePartTimeDescription)) +
  geom_boxplot(aes(fill = FullTimePartTimeDescription)) +
  geom_jitter(width = 0.10) +
  my_theme() +
  labs(title = "Course Outcomes by Student Credit Load", 
       y = "Course Grade (Percent)", 
       x = "", 
       color = "Credit Load",
       subtitle = "Summer 2020 BIOL 228 | Section 4001 and 4002",
       caption = "Note: This dataset excludes students who withdrew or had an incomplete term") +
  scale_fill_manual(values = c("#009DD9", "#999999")) +
  theme(legend.position = "") +
  scale_y_continuous(limits = c(0, 100)) 
```

#### Outcomes by Gender

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
statics %>%
  left_join(sis_no_acad_plan, by = "StudentID_Anon") %>%
  filter(!SISGradeLetter %in% c('W', 'CW', 'I')) %>%
  ggplot(aes(y = NormalizedScore, x = Gender)) +
  geom_boxplot(aes(fill = Gender)) +
  geom_jitter(width = 0.10) +
  my_theme() +
  labs(title = "Course Outcomes by Gender", 
       y = "Course Grade (Percent)", 
       x = "", 
       color = "Credit Load",
       subtitle = "Summer 2020 BIOL 228 | Section 4001 and 4002",
       caption = "Note: This dataset excludes students who withdrew or had an incomplete term") +
  scale_fill_manual(values = c("#009DD9", "#999999")) +
  theme(legend.position = "") +
  scale_y_continuous(limits = c(0, 100)) 
```

#### Outcomes by First Time Status

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
statics %>%
  left_join(sis_no_acad_plan, by = "StudentID_Anon") %>%
  filter(!SISGradeLetter %in% c('W', 'CW', 'I')) %>%
  ggplot(aes(y = NormalizedScore, x = as.factor(FirstTermAtInstution))) +
  geom_boxplot(aes(fill = as.factor(FirstTermAtInstution))) +
  geom_jitter(width = 0.10) +
  my_theme() +
  labs(title = "Course Outcomes by First Time at Inst. Status", 
       y = "Course Grade (Percent)", 
       x = "", 
       color = "Credit Load",
       subtitle = "Summer 2020 BIOL 228 | Section 4001 and 4002",
       caption = "Note: This dataset excludes students who withdrew or had an incomplete term") +
  scale_fill_manual(values = c("#009DD9", "#999999")) +
  theme(legend.position = "") +
  scale_y_continuous(limits = c(0, 100)) 
```

#### Outcomes by First Generation

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
tmp <- statics %>%
  left_join(sis_no_acad_plan, by = "StudentID_Anon") %>%
  filter(!SISGradeLetter %in% c('W', 'CW', 'I')) %>%
  mutate(Description = factor(Description, levels=c("Freshman", "Sophomore", "Junior", "Senior", "Post-Bacc Undergraduate")))

ggplot(tmp, aes(y = NormalizedScore, x = as.factor(Description))) +
  geom_boxplot(aes(fill = as.factor(Description)), outlier.shape = NA) +
  geom_jitter(width = 0.10) +
  my_theme() +
  labs(title = "Course Outcomes by First Generation Status", 
       y = "Course Grade (Percent)", 
       x = "", 
       color = "Credit Load",
       subtitle = "Summer 2020 BIOL 228 | Section 4001 and 4002",
       caption = "Note: This dataset excludes students who withdrew or had an incomplete term") +
  scale_fill_manual(values = c("#009DD9", "#999999", "#999999", "#999999", "#999999")) +
  theme(legend.position = "") +
  scale_x_discrete(labels = abbreviate) +
  scale_y_continuous(limits = c(0, 100)) #+
  #geom_text_repel(aes(y = NormalizedScore, x = as.factor(Description), label = round(NormalizedScore,0)))
  
```

```{r}
sis %>%
  group_by(as.factor(HasTransferCumGPA)) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
```


```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
tmp <- statics %>%
  left_join(sis_no_acad_plan, by = "StudentID_Anon") %>%
  filter(!SISGradeLetter %in% c('W', 'CW', 'I')) %>%
  mutate(HasTransferCumGPA = factor(HasTransferCumGPA, levels=c("0", "1")))

ggplot(tmp, aes(y = NormalizedScore, x = as.factor(HasTransferCumGPA))) +
  geom_boxplot(aes(fill = as.factor(HasTransferCumGPA)), outlier.shape = NA) +
  geom_jitter(width = 0.10) +
  my_theme() +
  labs(title = "Course Outcomes by First Generation Status", 
       y = "Course Grade (Percent)", 
       x = "", 
       color = "Credit Load",
       subtitle = "Summer 2020 BIOL 228 | Section 4001 and 4002",
       caption = "Note: This dataset excludes students who withdrew or had an incomplete term") +
  scale_fill_manual(values = c("#009DD9", "#999999", "#999999", "#999999", "#999999")) +
  theme(legend.position = "") +
  scale_x_discrete(labels = abbreviate) +
  scale_y_continuous(limits = c(0, 100)) #+
  #geom_text_repel(aes(y = NormalizedScore, x = as.factor(Description), label = round(NormalizedScore,0)))
  
```























