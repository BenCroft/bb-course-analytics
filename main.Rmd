---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set new parameters for reproducible pipeline

```{r}
course <- 'BIOL_228_4001'
```


## Load libraries

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)
library(stringr)
```

## Load helper scripts (functions)

```{r}
source("./scripts/wrangling.R")
source("./scripts/visualizer.R")
```

## Load data

### Set course path

```{r}
course_directory <- paste0("/Volumes/Departments/Extended\ Studies/DEHistData/Analytics_BC/", course, '/input/')
```

### Set data paths

```{r}
dynamics_path <- paste0(course_directory, "dynamics.csv")
grades_path <-paste0(course_directory, "grades.csv")
items_path <- paste0(course_directory, "items.csv")
statics_path <- paste0(course_directory, "statics.csv")
submissions_path <- paste0(course_directory, "submissions.csv")
sis_path <- paste0(course_directory, "sis.csv")
```

### Read data into memory

```{r}
dynamics <- read.csv(dynamics_path)
grades <- read.csv(grades_path)
items <- read.csv(items_path)
statics <- read.csv(statics_path)
submissions <- read.csv(submissions_path)
sis <- read.csv(sis_path)
```

## Process data

```{r}
## Ensure equal lengths among datasets
# length(unique(dynamics$StudentName))
# length(unique(grades$StudentName))
# length(unique(items$StudentName))
# length(unique(statics$StudentName))
# length(unique(dynamics$StudentName))
```

### Fix time formatting in `dynamics`

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
dynamics <- fix_time_band_24hr(dynamics)
dynamics <- fix_week_level(dynamics)
dynamics <- fix_day_of_week(dynamics)
```

### Fix data type in `sis`

```{r}
sis <- sis %>%
  mutate(StudentID = as.character(StudentID))
```


### Anonymize student identifiers

#### Create StudentID column

```{r}
dynamics <- create_student_id_col(dynamics)
grades <- create_student_id_col(grades)
items <- create_student_id_col(items)
statics <- create_student_id_col(statics)
```

#### Create anonymous/random ids

```{r}
set.seed(1)

student_roster <- union(dynamics$StudentID, grades$StudentID) # Intersect dynamics and grades
student_roster <- union(student_roster, items$StudentID)      # Intersect items    
student_roster <- union(student_roster, statics$StudentID)    # Intersect statics
student_roster <- union(student_roster, sis$StudentID)        # Intersect sis

student_count <- length(unique(student_roster))
student_anon_ids <- sample(10000:99999, student_count, replace=FALSE)
student_anon_df <- data.frame(student_roster, student_anon_ids) %>%
  rename(StudentID = student_roster, StudentID_Anon = student_anon_ids)

dynamics <- left_join(dynamics, student_anon_df, by = c("StudentID"))
grades <- left_join(grades, student_anon_df, by = c("StudentID"))
items <- left_join(items, student_anon_df, by = c("StudentID"))
statics <- left_join(statics, student_anon_df, by = c("StudentID"))
sis <- left_join(sis, student_anon_df, by = c("StudentID"))
```

#### Remove PII

```{r}
dynamics <- dynamics %>%
  select(-StudentName, -StudentID)
grades <- grades %>%
  select(-StudentName, -StudentID)
items <- items %>%
  select(-StudentName, -StudentID)
statics <- statics %>%
  select(-StudentName, -StudentID)
```










## Visualization

### Outcomes

#### Final Grade Distribution

```{r}
viz <- viz_FinalGradeDistribution(statics)
viz
```



































