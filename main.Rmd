---
title: "Untitled"
output: html_document
fig_width: 8
fig_height: 7
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set new parameters for reproducible pipeline

```{r}
# REQUIRED PARAMETERS
course <- 'BIOL_228_4001_4002'
course_directory <- paste0("/Volumes/Departments/Extended\ Studies/DEHistData/Analytics_BC/", course, '/input/')

# OPTIONAL PARAMETERS:

# Option 1: Combine two course sections
#course1_directory <- 
#course2_directory <- 
#course_combined_directory <- 
#course1_section_number <- 
#course2_section_number <- 
```

## Load libraries

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)
library(stringr)
library(ggrepel)
library(ggridges)
```

## Load helper scripts (functions)

```{r}
source("./scripts/wrangling.R")
source("./scripts/visualizer.R")
source("./scripts/section_combiner.R")
```

## Load viz theme (put in `visualizer.R` later)

```{r}
my_theme <- function() {
  background_color <- "transparent" #"transparent"
  # Other key values
  theme_bw(base_size = 18, base_family = "Avenir") +#%+replace% 
    #quartzFonts(ANXTC = c("Avenir Next Condensed Regular", "Avenir Next Condensed Demi Bold", "Avenir Next Condensed Italic", "Avenir Next Condensed Demi Bold Italic"))
    #theme(text = element_text(family = "ANXTC")) +
    theme(panel.background = element_rect(fill = background_color, color = NA)) +
    theme(panel.border = element_rect(color = background_color)) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(panel.grid.major.y = element_line(colour = "#dddddd", linetype = "dotted", size = 1)) + 
    #theme(panel.grid.major.x=element_blank()) +    
    #theme(panel.grid.minor.y = element_line(colour = "#B6B6B9", linetype = "dotted")) + 
    #theme(panel.grid.minor.x =element_blank()) +    
    theme(plot.background = element_rect(fill = background_color, color = NA)) +
    theme(plot.title = element_text(color = "gray30", face = "bold", size = 20, vjust = 1.00)) +
    theme(plot.subtitle = element_text(color = "#707276",  face = "plain", size = 16)) +   
    theme(plot.caption = element_text(color = "#707276", size = 12, face = "plain")) +
    #theme(strip.background = element_rect(fill="white")) +
    theme(axis.ticks = element_blank()) +
    theme(axis.line = element_line(color = "grey30", size = 0.5, linetype = "solid")) + 
    theme(axis.text.x = element_text(size = 16, color = "gray30")) +
    theme(axis.text.y = element_text(size = 16, color = "gray30")) +
    theme(axis.title.x = element_text(size = 16, color = "gray50", vjust = 0)) +
    theme(axis.title.y = element_text(size = 16, color = "gray50", vjust = 1.00)) + 
    theme(legend.position = "top") + #theme(legend.position = "") +
    theme(legend.background = element_rect(fill = background_color)) +
    theme(legend.key = element_rect(color = background_color)) +
    theme(legend.key.width = unit(0.9, "cm")) +
    theme(legend.key.height = unit(0.9, "cm")) +
    theme(legend.text = element_text(size = 14, face = "plain", color = "gray50")) +
    theme(legend.title = element_text(size = 16, face = "bold")) +
    theme(plot.margin = margin(1, 1, 1, 1, "cm")) 
}
```

## Load data

### Set data paths

```{r}
dynamics_path <- paste0(course_directory, "dynamics.csv")
grades_path <-paste0(course_directory, "grades.csv")
items_path <- paste0(course_directory, "items.csv")
statics_path <- paste0(course_directory, "statics.csv")
submissions_path <- paste0(course_directory, "submissions.csv")
sis_path <- paste0(course_directory, "sis.csv")
```

### Read data into memory

```{r}
dynamics_input    <- read.csv(dynamics_path)
grades_input      <- read.csv(grades_path)
items_input       <- read.csv(items_path)
statics_input     <- read.csv(statics_path)
submissions_input <- read.csv(submissions_path)
sis_input         <- read.csv(sis_path)
```

```{r}
dynamics <- dynamics_input
grades <- grades_input
items <- items_input
statics <- statics_input
submissions <- submissions_input
sis_acad_plan <- sis_input
sis_no_acad_plan <- sis_input
```

## Process data

### Remove duplicates from `sis_no_acad_plan` due to plan and subplan column removal

```{r}
# Find duplicates in students - largely due to multiple AcademicPlan values per student
# sis %>%
#   select(-AcademicSubPlan, -AcademicPlan) %>%
#   distinct() %>%
#   group_by(StudentID_Anon) %>%
#   summarise(count = n()) %>%
#   arrange(desc(count)) 

sis_no_acad_plan <- sis_no_acad_plan %>%
  select(-AcademicPlan, -AcademicSubPlan) %>%
  distinct()
```

### Fix time formatting in `dynamics`

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
dynamics <- fix_time_band_24hr(dynamics)
dynamics <- fix_week_level(dynamics)
dynamics <- fix_day_of_week(dynamics)
```

### Add space in BISQL student names

```{r}
sis_acad_plan %>%
  mutate(StudentName = addSpace(StudentName))
sis_no_acad_plan %>%
  mutate(StudentName = addSpace(StudentName))
```

```{r}
## Ensure equal lengths among datasets
# length(unique(dynamics$StudentName))
# length(unique(grades$StudentName))
# length(unique(items$StudentName))
# length(unique(sis_acad_plan$StudentName))
# length(unique(sis_no_acad_plan$StudentName))
# length(unique(statics$StudentName))
# length(unique(submissions$StudentName))
```

### Fix data type in `sis_acad_plan` and `sis_no_acad_plan`

```{r}
sis_acad_plan <- sis_acad_plan %>%
  mutate(StudentID = as.character(StudentID))
sis_no_acad_plan <- sis_no_acad_plan %>%
  mutate(StudentID = as.character(StudentID))
```

### Anonymize student identifiers

#### Create StudentID column

```{r}
dynamics <- create_student_id_col(dynamics)
grades <- create_student_id_col(grades)
items <- create_student_id_col(items)
statics <- create_student_id_col(statics)
```

#### Create anonymous/random ids

```{r}
set.seed(1)

student_roster <- union(dynamics$StudentID, grades$StudentID)       # Intersect dynamics and grades
student_roster <- union(student_roster, items$StudentID)            # Intersect items    
student_roster <- union(student_roster, statics$StudentID)          # Intersect statics
student_roster <- union(student_roster, sis_acad_plan$StudentID)    # Intersect sis_acad_plan
student_roster <- union(student_roster, sis_no_acad_plan$StudentID) # Intersect sis_no_acad_plan


# Create hash table for anonymous student ids
student_count <- length(unique(student_roster))
student_anon_ids <- sample(10000:99999, student_count, replace=FALSE)
student_anon_df <- data.frame(student_roster, student_anon_ids) %>%
  rename(StudentID = student_roster, StudentID_Anon = student_anon_ids)

dynamics <- left_join(dynamics, student_anon_df, by = c("StudentID"))
grades <- left_join(grades, student_anon_df, by = c("StudentID"))
items <- left_join(items, student_anon_df, by = c("StudentID"))
statics <- left_join(statics, student_anon_df, by = c("StudentID"))
sis_acad_plan <- left_join(sis_acad_plan, student_anon_df, by = c("StudentID"))
sis_no_acad_plan <- left_join(sis_no_acad_plan, student_anon_df, by = c("StudentID"))
```

#### Remove PII

```{r}
dynamics <- dynamics %>%
  select(-StudentName, -StudentID)
grades <- grades %>%
  select(-StudentName, -StudentID)
items <- items %>%
  select(-StudentName, -StudentID)
statics <- statics %>%
  select(-StudentName, -StudentID)
sis_acad_plan <- sis_acad_plan %>%
  select(-StudentName, -StudentID, -EmployeeID)
sis_no_acad_plan <- sis_no_acad_plan %>%
  select(-StudentName, -StudentID, -EmployeeID)
```

## Visualization

### Outcomes

#### Final Grade Distribution

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
v <- viz_FinalGradeDistribution(statics)
```

#### Outcomes by Student Credit Load

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
v <- viz_OutcomesByStudentCreditLoad(statics, sis_no_acad_plan)
```

#### Outcomes by Gender

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
v <- viz_OutcomesByGender(statics, sis_no_acad_plan)
```

#### Outcomes by First Time Status

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
v <- viz_OutcomesByFirstTermAtInstitution(statics, sis_no_acad_plan)
```

#### Outcomes by Academic Level

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
v <- viz_OutcomesByAcademicLevel(statics, sis_no_acad_plan)
```

#### Outcomes by First Gen

```{r, fig.retina = 2, fig.width = 8, fig.height = 7}
v <- viz_OutcomesByFirstGeneration(statics, sis_no_acad_plan)
```

### Item Grades

```{r, fig.height = 11, fig.width = 8}
v <- viz_CourseItemGradeDistributions(grades)
v
```

## Bb Activities by Group

```{r}
statics %>%
  group_by(SISGradeLetter) %>%
  summarise(StudentCount = n(),
            Minutes_Mean = round(mean(CourseAccessMinutes),1),
            Hours_Mean = round(mean(CourseAccessMinutes/60),1),
            Minutes_Median = round(median(CourseAccessMinutes),1),
            Hours_Median = round(median(CourseAccessMinutes/60),1),
            Logins_Mean = round(mean(CourseAccesses),1),
            Logins_Median = round(median(CourseAccesses),1),
            Db_Posts_Mean = round(mean(ForumPosts),1),
            Db_Posts_Median =round(median(ForumPosts),1),
            Db_Chars_Mean = round(mean(ForumPostCharacters),1),
            Db_Chars_Median = round(median(ForumPostCharacters),1)) %>%
  mutate(SISGradeLetter = factor(SISGradeLetter,levels = c("A+", "A", "A-", 
                                                             "B+", "B", "B-", 
                                                             "C+", "C", "C-", 
                                                             "D+", "D", "D-", 
                                                             "F", "CW", "W", "I"))) %>%
  arrange(SISGradeLetter)
  
```

```{r}
statics %>%
  group_by(SISGradeLetter) %>%
  summarise(n())
```




















