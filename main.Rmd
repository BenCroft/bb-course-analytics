---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set new parameters for reproducible pipeline

```{r}
course <- 'BIOL_228_4001'
```


## Load libraries

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)
library(stringr)
```

## Load helper scripts (functions)

```{r}
source("./scripts/wrangling.R")
source("./scripts/visualizer.R")
```

## Load viz theme (put in `visualizer.R` later)

```{r}
my_theme <- function() {
  background_color <- "transparent" #"transparent"
  # Other key values
  theme_bw(base_size = 18, base_family = "Avenir") +#%+replace% 
    #quartzFonts(ANXTC = c("Avenir Next Condensed Regular", "Avenir Next Condensed Demi Bold", "Avenir Next Condensed Italic", "Avenir Next Condensed Demi Bold Italic"))
    #theme(text = element_text(family = "ANXTC")) +
    theme(panel.background = element_rect(fill = background_color, color = NA)) +
    theme(panel.border = element_rect(color = background_color)) +
    theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor = element_blank()) +
    theme(panel.grid.major.y = element_line(colour = "#dddddd", linetype = "dotted", size = 1)) + 
    #theme(panel.grid.major.x=element_blank()) +    
    #theme(panel.grid.minor.y = element_line(colour = "#B6B6B9", linetype = "dotted")) + 
    #theme(panel.grid.minor.x =element_blank()) +    
    theme(plot.background = element_rect(fill = background_color, color = NA)) +
    theme(plot.title = element_text(color = "gray30", face = "bold", size = 20, vjust = 1.00)) +
    theme(plot.subtitle = element_text(color = "#707276",  face = "plain", size = 16)) +   
    theme(plot.caption = element_text(color = "#707276", size = 12, face = "plain")) +
    #theme(strip.background = element_rect(fill="white")) +
    theme(axis.ticks = element_blank()) +
    theme(axis.line = element_line(color = "grey30", size = 0.5, linetype = "solid")) + 
    theme(axis.text.x = element_text(size = 16, color = "gray30")) +
    theme(axis.text.y = element_text(size = 16, color = "gray30")) +
    theme(axis.title.x = element_text(size = 16, color = "gray50", vjust = 0)) +
    theme(axis.title.y = element_text(size = 16, color = "gray50", vjust = 1.00)) + 
    theme(legend.position = "top") + #theme(legend.position = "") +
    theme(legend.background = element_rect(fill = background_color)) +
    theme(legend.key = element_rect(color = background_color)) +
    theme(legend.key.width = unit(0.9, "cm")) +
    theme(legend.key.height = unit(0.9, "cm")) +
    theme(legend.text = element_text(size = 14, face = "plain", color = "gray50")) +
    theme(legend.title = element_text(size = 16, face = "bold")) +
    theme(plot.margin = margin(1, 1, 1, 1, "cm")) 
}
```


## Load data

### Set course path

```{r}
course_directory <- paste0("/Volumes/Departments/Extended\ Studies/DEHistData/Analytics_BC/", course, '/input/')
```

### Set data paths

```{r}
dynamics_path <- paste0(course_directory, "dynamics.csv")
grades_path <-paste0(course_directory, "grades.csv")
items_path <- paste0(course_directory, "items.csv")
statics_path <- paste0(course_directory, "statics.csv")
submissions_path <- paste0(course_directory, "submissions.csv")
sis_path <- paste0(course_directory, "sis.csv")
```

### Read data into memory

```{r}
dynamics <- read.csv(dynamics_path)
grades <- read.csv(grades_path)
items <- read.csv(items_path)
statics <- read.csv(statics_path)
submissions <- read.csv(submissions_path)
sis <- read.csv(sis_path)
```

## Process data

```{r}
## Ensure equal lengths among datasets
# length(unique(dynamics$StudentName))
# length(unique(grades$StudentName))
# length(unique(items$StudentName))
# length(unique(statics$StudentName))
# length(unique(dynamics$StudentName))
```

### Fix time formatting in `dynamics`

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
dynamics <- fix_time_band_24hr(dynamics)
dynamics <- fix_week_level(dynamics)
dynamics <- fix_day_of_week(dynamics)
```

### Fix data type in `sis`

```{r}
sis <- sis %>%
  mutate(StudentID = as.character(StudentID))
```


### Anonymize student identifiers

#### Create StudentID column

```{r}
dynamics <- create_student_id_col(dynamics)
grades <- create_student_id_col(grades)
items <- create_student_id_col(items)
statics <- create_student_id_col(statics)
```

#### Create anonymous/random ids

```{r}
set.seed(1)

student_roster <- union(dynamics$StudentID, grades$StudentID) # Intersect dynamics and grades
student_roster <- union(student_roster, items$StudentID)      # Intersect items    
student_roster <- union(student_roster, statics$StudentID)    # Intersect statics
student_roster <- union(student_roster, sis$StudentID)        # Intersect sis

student_count <- length(unique(student_roster))
student_anon_ids <- sample(10000:99999, student_count, replace=FALSE)
student_anon_df <- data.frame(student_roster, student_anon_ids) %>%
  rename(StudentID = student_roster, StudentID_Anon = student_anon_ids)

dynamics <- left_join(dynamics, student_anon_df, by = c("StudentID"))
grades <- left_join(grades, student_anon_df, by = c("StudentID"))
items <- left_join(items, student_anon_df, by = c("StudentID"))
statics <- left_join(statics, student_anon_df, by = c("StudentID"))
sis <- left_join(sis, student_anon_df, by = c("StudentID"))
```

#### Remove PII

```{r}
dynamics <- dynamics %>%
  select(-StudentName, -StudentID)
grades <- grades %>%
  select(-StudentName, -StudentID)
items <- items %>%
  select(-StudentName, -StudentID)
statics <- statics %>%
  select(-StudentName, -StudentID)
sis <- sis %>%
  select(-StudentName, -StudentID, -EmployeeID)
```

## Visualization

### Outcomes

#### Final Grade Distribution

```{r}
viz <- viz_FinalGradeDistribution(statics)
viz
```

```{r, fig.retina = 2, fig.width = 8.5, fig.height = 8}
statics %>%
  left_join(sis, by = "StudentID_Anon") %>%
  filter(!SISGradeLetter %in% c('W', 'CW', 'I')) %>%
  ggplot(aes(y = NormalizedScore, x = FullTimePartTimeDescription)) +
  geom_boxplot(aes(fill = FullTimePartTimeDescription)) +
  geom_jitter(width = 0.10) +
  my_theme() +
  labs(title = "Course Outcomes by Student Credit Load", 
       y = "Course Grade (Percent)", 
       x = "", 
       color = "Credit Load",
       subtitle = "Summer 2020 BIOL 228 | Section 4001 and 4002",
       caption = "Note: This dataset excludes students who withdrew or had an incomplete term") +
  scale_fill_manual(values = c("#009DD9", "#999999")) +
  theme(legend.position = "")

  
```

```{r}
# Join statics with demographics


ggplot()
```




```{r}
  # Step 1: Prep the data
  statics_viz_df1 <- statics %>%
    select(SISGradeLetter) %>%
    mutate(SISGradeLetter = factor(SISGradeLetter,levels = c("A+", "A", "A-", 
                                                             "B+", "B", "B-", 
                                                             "C+", "C", "C-", 
                                                             "D+", "D", "D-", 
                                                             "F", "CW", "W")))
  
  statis_viz_df2 <- data.frame(table(statics_viz_df1)) %>%
    rename(SISGradeLetter = statics_viz_df1) %>%
    mutate(Count = Freq) %>% 
    mutate(Outcome = case_when(SISGradeLetter %in% c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-") ~ "Above C-",
                               SISGradeLetter %in% c("D+", "D", "D-", "F") ~ "DF",
                               SISGradeLetter %in% c("CW", "W", "I") ~ "Withdrew/Incomplete")) %>%
    mutate(RowNumber = row_number()) %>%
    select(RowNumber, SISGradeLetter, Freq, Outcome)
  
  # #####################################
  # Step 2: Build the visualization
  g <- ggplot(statis_viz_df2, aes(x = SISGradeLetter, y = Freq)) + 
    geom_bar(stat = "identity", aes(fill = Outcome), alpha = 0.8) +
    #   # Add the theme layers
    my_theme() +
    
    scale_y_continuous(breaks = pretty_breaks()) +
    scale_fill_manual(name = "Outcome", 
                      labels = c("Above C-", "Below C-", "Withdrew"), 
                      values = c("#009DD9", "#192841", "#999999")) +
    
    # Add labels
    labs(title = "Final Grade Distribution",
         subtitle = "Number of students receiving each grade letter",
         caption = paste0("eCampus Center"),
         x = "Grade Letter",
         y = "Number of Students")
  g
```





























